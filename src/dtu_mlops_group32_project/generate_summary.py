import os
import torch
from model import BartSummarizer
from typing import Dict
from google.cloud import storage

def download_model(bucket_name: str, source_blob_name: str, destination_file_name: str) -> None:
    """Downloads a file from Google Cloud Storage."""
    storage_client = storage.Client()
    bucket = storage_client.bucket(bucket_name)
    blob = bucket.blob(source_blob_name)
    blob.download_to_filename(destination_file_name)
    print(f"Downloaded {source_blob_name} to {destination_file_name}.")

def generate_summary(text: str, model_path: str = "gs://dtu_mlops_group32_project_bucket/models/final_model.pt") -> Dict[str, str]:
    """
    Generate summary from input text using loaded BART model.
    
    Args:
        text: Input text to summarize
        model_path: Path to the saved model weights (local or GCS)
        
    Returns:
        Dict containing original text and generated summary
    """
    local_model_path = "./models/final_model.pt"  

    os.makedirs(os.path.dirname(local_model_path), exist_ok=True)

    if model_path.startswith("gs://"):
        print("Downloading model from GCS...")
        bucket_name, source_blob_name = model_path[5:].split("/", 1)
        download_model(
            bucket_name=bucket_name,
            source_blob_name=source_blob_name,
            destination_file_name=local_model_path
        )
    else:
        local_model_path = model_path

    model = BartSummarizer()
    model.load_state_dict(torch.load(local_model_path))
    model.eval()

    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model = model.to(device)

    inputs = model.tokenizer(
        text,
        max_length=model.max_source_length,
        padding="max_length",
        truncation=True,
        return_tensors="pt"
    ).to(device)

    with torch.no_grad():
        summary_ids = model.model.generate(
            inputs.input_ids,
            attention_mask=inputs.attention_mask,
            max_length=model.max_target_length,
            num_beams=4,
            early_stopping=True
        )

    summary = model.tokenizer.decode(summary_ids[0], skip_special_tokens=True)

    return {
        "input_text": text,
        "summary": summary
    }

result = generate_summary(text="'article': 'world - wide , infertility affects 1015% of couples who are trying to conceive , and about 15% of these cases are caused by male factors , which affect 1 out of 20 men in the general population . \n most cases of male infertility are idiopathic , apart from several etiologies , such as obstruction of deferent duct , varicocele , sexual dysfunction , and cryptorchidism . \n although assisted reproductive technology ( art ) has helped many sterile couples to conceive , non - obstructive azoospermia ( noa ) , which accounts for a considerable proportion of male infertility , has a dramatically lower rate of sperm retrieval and clinical pregnancy . \n the etiological mechanism of noa is unknown , but factors such as oxidative stress were considered to have effects on spermatogenesis , and some antioxidants have been effective in protecting spermatogenesis . \n therefore , it is helpful to explore the underlying pathogenesis of noa in these patients . micrornas are a class of small rnas that do not code amino acid sequences , but they play fundamental roles in regulating gene expression after transcription . \n lian et al . found 154 down - regulated mirnas and 19 up - regulated mirnas in testes of noa patients compared to fertile males , by using microarray technologies . \n furthermore , some of the mirnas have been shown to affect the proliferation , apoptosis , and dna damage in germ cells [ 911 ] . \n mir-210 is one of the 19 up - regulated mirnas in testes of noa patients , located within the genomic loci of transcript ak123483 . \n it can be induced by hypoxia , and plays an essential role in cell adaptation to hypoxia . \n mir-210 also affects regulation of diverse physiological processes , such as angiogenesis , cell survival , proliferation , cell cycle arrest , protein modification , and dna damage repair . \n although mir-210 has been shown to be involved in regulation of physiological processes in various diseases and to be an up - regulated mirna in testes of noa patients , it remains unknown how mir-210 affects spermatogenesis . \n hence , the aim of this study was to investigate the underlying mechanisms by which mir-210 is involved in the pathogenesis of spermatogenesis . \n we enrolled 25 patients ( aged 1841 years ) with azoospermia ( proven by 3 semen analyses from testicular biopsies from the first affiliated hospital of anhui medical university ) . \n pathological examinations were performed on each testicular specimen . combined with clinical features , 4 patients were diagnosed as having sertoli - cell - only syndrome ( scos ) , 7 patients were diagnosed as having maturation arrest ( ma ) , 8 patients were diagnosed as having hypospermatogenesis , and the other 6 patients were diagnosed as having obstructive azoospermia ( oa ) . all patients provided informed consent before their participation in this study . \n our local medical ethics committee approved this study before it began . to examine the location of insulin - like growth factor ii \n ( igf2 ) in human testicular tissues , we performed immunohistochemistry staining to detect the igf2 expression . \n tissues were cut into sections for immunoperoxidase staining after being treated with 4% pfa and paraffin wax . \n after the specific treatment with standard - procedure immunohistochemistry staining as described as lian et al . , sections were incubated with igf2 antibody ( abcam ) overnight at 4c and biotinylated secondary antibody ( abcam ) for 2 h at room temperature . to detect expression of mir-210 , \n rnas were extracted from nt-2 cells or tissues and subjected to real - time pcr as described as lian et al . . \n briefly , rna extraction was performed following a standard trizol protocol , real - time pcr was carried out with the abi step one system ( applied biosystems ) , and the sybr premix ex taq ii kit ( takara bio , inc . ) was used . \n primers for q - rt pcr were as follows : forward primer : 5-caataactgtgcgtgtgacagc-3 reverse primer : 5-tatggttttgacgactgtgtgat-3 forward primer : 5-cagcacatatactaaaattggaacg-3 reverse primer : 5-acgaatttgcgtgtcatcc-3 western blot analysis was carried out to detect protein expression of igf2 in the human testicular tissues in the 3 groups and in nt2 cells . \n anti - igf2 ( abcam ) was used for western blot analysis , and we used -actin as a loading control to detect expression of igf2 . \n we supplemented the medium with 10% fetal bovine serum ( life technology inc . ) , 1% antibiotics ( 100 units / ml penicillin , and 100 ug / ml streptomycin , life technology inc . ) . \n cells were incubated at 37c in a humidified incubator with 5% co2 . to transfect oligonucleotides and plasmids into nt-2 cells , lipofectamine rnaimax ( invitrogen ) and fugene hd ( roche ) \n all processes were performed in accordance with the protocols supplied by manufacturers . in this study , all the experiments were performed independently at least 3 times . \n we enrolled 25 patients ( aged 1841 years ) with azoospermia ( proven by 3 semen analyses from testicular biopsies from the first affiliated hospital of anhui medical university ) . \n pathological examinations were performed on each testicular specimen . combined with clinical features , 4 patients were diagnosed as having sertoli - cell - only syndrome ( scos ) , 7 patients were diagnosed as having maturation arrest ( ma ) , 8 patients were diagnosed as having hypospermatogenesis , and the other 6 patients were diagnosed as having obstructive azoospermia ( oa ) . all patients provided informed consent before their participation in this study . \n to examine the location of insulin - like growth factor ii ( igf2 ) in human testicular tissues , we performed immunohistochemistry staining to detect the igf2 expression . \n tissues were cut into sections for immunoperoxidase staining after being treated with 4% pfa and paraffin wax . \n after the specific treatment with standard - procedure immunohistochemistry staining as described as lian et al . \n , sections were incubated with igf2 antibody ( abcam ) overnight at 4c and biotinylated secondary antibody ( abcam ) for 2 h at room temperature . \n rnas were extracted from nt-2 cells or tissues and subjected to real - time pcr as described as lian et al . . \n briefly , rna extraction was performed following a standard trizol protocol , real - time pcr was carried out with the abi step one system ( applied biosystems ) , and the sybr premix ex taq ii kit ( takara bio , inc . ) was used . \n primers for q - rt pcr were as follows : forward primer : 5-caataactgtgcgtgtgacagc-3 reverse primer : 5-tatggttttgacgactgtgtgat-3 forward primer : 5-cagcacatatactaaaattggaacg-3 reverse primer : 5-acgaatttgcgtgtcatcc-3 \n western blot analysis was carried out to detect protein expression of igf2 in the human testicular tissues in the 3 groups and in nt2 cells . \n anti - igf2 ( abcam ) was used for western blot analysis , and we used -actin as a loading control to detect expression of igf2 . \n we supplemented the medium with 10% fetal bovine serum ( life technology inc . ) , 1% antibiotics ( 100 units / ml penicillin , and 100 ug / ml streptomycin , life technology inc . ) . \n cells were incubated at 37c in a humidified incubator with 5% co2 . to transfect oligonucleotides and plasmids into nt-2 cells , lipofectamine rnaimax ( invitrogen ) and fugene hd ( roche ) \n  \n the igf2 gene is part of a cluster of imprinted genes expressing the single polypeptide as igf2 , which is only produced from the paternal allele . \n the maternal allele is transcriptionally silent . to clarify the location of igf2 in human testicular tissues , \n we found igf2 located in spermatocytes in the testes of patients with oa ( figure 1 ) . because igf2 is located in spermatocytes of the testis , we detected the expression of igf2 in cases with ma , hypospermatogenesis , and oa , but not in the scos patients . \n we found that igf2 was down - regulated in patients with ma and hypospermatogenesis compared to oa patients , which was considered as the control group with normal spermatogenesis , although without a significant difference ( figures 2 , 3 ) , possibly because there were fewer samples and longer preservation times of some samples . \n quantitative real - time pcr was performed to examined mir-210 expression in the testis of patients with ma , hypospermatogenesis , and oa . we found that mir-210 was significantly up - regulated in the testis of ma and hypospermatogenesis patients compared to oa patients ( figure 4 ) . however , due to errors in the rna extraction in the preliminary experiment , 3 testis samples ( 1 each ) from ma , hypospermatogenesis , and oa patients were damaged and were not tested . in the targetscan database , because the 3utr of the igf2-mrna has a putative mir-210-binding site , igf2 was predicted to be a potential target of mir-210 . to identify whether the igf2 gene was targeted by mir-210 directly , renilla luciferase reporters , which include the wild - type full - length 3utr forms of mir-210 seeding sites , \n figure 5 shows that there was a 60% decrease in luciferase activity after cotransfection of the mir-210 mimic and the renilla luciferase reporters into nt2 cells , and inhibiting mir-210 expression increased activity of the reporter renilla luciferase . \n expression of igf2 protein was also significantly lower in the nt2 cells transfected with mir-210 mimics than in control cells , and knockdown of mir-210 with mir-210 inhibitor increased protein expression of igf2 ( figures 6 ) . \n the igf2 gene is part of a cluster of imprinted genes expressing the single polypeptide as igf2 , which is only produced from the paternal allele . \n the maternal allele is transcriptionally silent . to clarify the location of igf2 in human testicular tissues , \n we found igf2 located in spermatocytes in the testes of patients with oa ( figure 1 ) . \n because igf2 is located in spermatocytes of the testis , we detected the expression of igf2 in cases with ma , hypospermatogenesis , and oa , but not in the scos patients . \n we found that igf2 was down - regulated in patients with ma and hypospermatogenesis compared to oa patients , which was considered as the control group with normal spermatogenesis , although without a significant difference ( figures 2 , 3 ) , possibly because there were fewer samples and longer preservation times of some samples . \n quantitative real - time pcr was performed to examined mir-210 expression in the testis of patients with ma , hypospermatogenesis , and oa . we found that mir-210 was significantly up - regulated in the testis of ma and hypospermatogenesis patients compared to oa patients ( figure 4 ) . however , due to errors in the rna extraction in the preliminary experiment , 3 testis samples ( 1 each ) from ma , hypospermatogenesis , and oa patients were damaged and were not tested . \n in the targetscan database , because the 3utr of the igf2-mrna has a putative mir-210-binding site , igf2 was predicted to be a potential target of mir-210 . to identify whether the igf2 gene was targeted by mir-210 directly , renilla luciferase reporters , which include the wild - type full - length 3utr forms of mir-210 seeding sites , were used . \n figure 5 shows that there was a 60% decrease in luciferase activity after cotransfection of the mir-210 mimic and the renilla luciferase reporters into nt2 cells , and inhibiting mir-210 expression increased activity of the reporter renilla luciferase . \n expression of igf2 protein was also significantly lower in the nt2 cells transfected with mir-210 mimics than in control cells , and knockdown of mir-210 with mir-210 inhibitor increased protein expression of igf2 ( figures 6 ) . \n during recent decades several studies have focused on the effects of mirnas on spermatogenesis in male infertility [ 911,17 ] . \n however , it was not understood how mir-210 , which is one of the up - regulated mirnas in testes of patients with noa , was involved in spermatogenesis in male infertility . \n the transformation of diploid spermatogonia into mature haploid cells in spermatogenesis is a complex biological process in the testes of males . \n the insulin / igf system takes part in the processes of cell proliferation , cell growth , differentiation , and survival , which affects nearly every organ in the body . \n also , insulin / igf plays an important role in the proper function of the testis in males . \n igf2 binds to igf1r and insr - a with a high affinity and binds to insr - a / igf1r , insr - b / igf1r , but with lower affinity . \n found that in inactivated insr and igf1r , there was a 79% reduction in daily sperm production in adult mouse testes by a conditional ko approach . taken together , the aforementioned data suggest that igf2 might be involved in the process of spermatogenesis . to examine the specific mechanism by which mir-210 is associated with the process of spermatogenesis , quantitative real - time pcr was performed to detect mir-210 expression . \n we found that mir-210 was significantly up - regulated in the testes of subjects with ma and hypospermatogenesis patients compared to oa . \n these results agree with findings of lian et al . using microarray technologies performed in noa and normal controls . \n several studies have suggested that this mirna could be mediated by hypoxia and participate in various types of regulation of angiogenesis , cell survival , proliferation , cell cycle arrest , and protein modification [ 1214 ] . \n furthermore , some researchers even found that mir-210 might be considered as one of the indicated markers in some diseases , such as clear cell renal cell carcinoma and acute myeloid leukemia . in the present study we found that igf2 was targeted by mir-210 directly in the in vitro experiment in nt2 cells , and mir-210 might be associated with spermatogenesis by targeting igf2 in male infertility . \n firstly , as some errors occurred in the rna extraction in the preliminary experiment , mir-210 of 3 testes samples were damaged and not detected in the subsequent quantitative real - time pcr experiment , which might have affected our results . \n secondly , we did not investigate the functions of mir-210 and igf2 in vitro or in vivo , and we plan to do this in future research . \n we demonstrated that mir-210 might be associated with spermatogenesis by targeting igf2 in male infertility . \n future mechanistic studies on the role of mir-210/igf2 in the process of spermatogenesis in male infertility will provide new insights into the diagnosis and management of male infertility .',")

print(result["summary"])